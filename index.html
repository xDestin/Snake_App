<!DOCTYPE html>
<html>
<head>
  <title>Simple Chess App</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css" />
  <style>
    #board { width: 400px; }
    #controls { margin-top: 15px; }
    button { padding: 8px 12px; margin: 5px; }
    .difficulty-btn { background: #eee; border: 1px solid #ccc; cursor: pointer; }
    .difficulty-btn:hover { background: #ddd; }
    .selected-square { background-color: rgba(255, 255, 0, 0.6) !important; }
  </style>
</head>
<body>
  <div id="board"></div>
  <div id="controls">
    <button id="playHuman">Play Human vs Human</button>
    <div>
      <span>Play vs AI:</span>
      <button class="difficulty-btn" data-diff="1">Easy</button>
      <button class="difficulty-btn" data-diff="2">Medium</button>
      <button class="difficulty-btn" data-diff="3">Hard</button>
    </div>
  </div>

  <!-- Add jQuery first -->
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

  <!-- Then chess.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>

  <!-- Then chessboard.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>

  <script>
    let board, game;
    let aiEnabled = false;
    let aiDepth = 1;
    let selectedSquare = null;

    window.onload = function() {
      game = new Chess();
      board = Chessboard('board', {
        position: 'start',
        draggable: true, // keep drag enabled as fallback
        onDrop: onDrop
      });

      // Human vs human
      document.getElementById('playHuman').onclick = () => startHumanGame();

      // AI difficulty buttons
      document.querySelectorAll('.difficulty-btn').forEach(btn => {
        btn.addEventListener('click', () => startAIGame(parseInt(btn.dataset.diff)));
      });

      // Tap-to-move: intercept clicks on board squares
      $('#board').on('click', '.square-55d63', function() {
        let square = $(this).attr('data-square');
        handleSquareClick(square);
      });
    };

    function startHumanGame() {
      aiEnabled = false;
      game.reset();
      board.position('start');
      selectedSquare = null;
    }

    function startAIGame(difficulty) {
      aiEnabled = true;
      aiDepth = difficulty;
      game.reset();
      board.position('start');
      selectedSquare = null;
    }

    function onDrop(source, target) {
      const move = game.move({ from: source, to: target, promotion: 'q' });
      if (move === null) return 'snapback';
      if (aiEnabled && !game.game_over()) setTimeout(makeAIMove, 250);
    }

    function handleSquareClick(square) {
      if (!selectedSquare) {
        // First click: select a piece
        const moves = game.moves({ square, verbose: true });
        if (moves.length === 0) return; // no piece there
        selectedSquare = square;
        highlightSquare(square);
      } else {
        // Second click: attempt move
        let move = game.move({ from: selectedSquare, to: square, promotion: 'q' });
        clearHighlights();
        if (move === null) {
          selectedSquare = null;
          return;
        }
        board.position(game.fen());
        selectedSquare = null;

        if (aiEnabled && !game.game_over()) {
          setTimeout(makeAIMove, 250);
        }
      }
    }

    function highlightSquare(square) {
      clearHighlights();
      $(`.square-${square}`).addClass('selected-square');
    }

    function clearHighlights() {
      $('.square-55d63').removeClass('selected-square');
    }

    function makeAIMove() {
      let bestMove = getBestMove(game, aiDepth);
      game.move(bestMove);
      board.position(game.fen());
    }

    function getBestMove(game, depth) {
      if (depth === 1) {
        let moves = game.moves();
        return moves[Math.floor(Math.random() * moves.length)];
      }
      return minimaxRoot(depth, game, true);
    }

    function minimaxRoot(depth, game, isMaximizingPlayer) {
      let newGameMoves = game.moves();
      let bestMove = -Infinity;
      let bestMoveFound;

      for (let i = 0; i < newGameMoves.length; i++) {
        let move = newGameMoves[i];
        game.move(move);
        let value = minimax(depth - 1, game, -Infinity, Infinity, !isMaximizingPlayer);
        game.undo();
        if (value > bestMove) {
          bestMove = value;
          bestMoveFound = move;
        }
      }
      return bestMoveFound;
    }

    function minimax(depth, game, alpha, beta, isMaximizingPlayer) {
      if (depth === 0) return -evaluateBoard(game.board());
      let newGameMoves = game.moves();

      if (isMaximizingPlayer) {
        let bestMove = -Infinity;
        for (let i = 0; i < newGameMoves.length; i++) {
          game.move(newGameMoves[i]);
          bestMove = Math.max(bestMove, minimax(depth - 1, game, alpha, beta, !isMaximizingPlayer));
          game.undo();
          alpha = Math.max(alpha, bestMove);
          if (beta <= alpha) break;
        }
        return bestMove;
      } else {
        let bestMove = Infinity;
        for (let i = 0; i < newGameMoves.length; i++) {
          game.move(newGameMoves[i]);
          bestMove = Math.min(bestMove, minimax(depth - 1, game, alpha, beta, !isMaximizingPlayer));
          game.undo();
          beta = Math.min(beta, bestMove);
          if (beta <= alpha) break;
        }
        return bestMove;
      }
    }

    function evaluateBoard(board) {
      const values = { p: 1, n: 3, b: 3, r: 5, q: 9, k: 1000 };
      let eval = 0;
      for (let row of board) {
        for (let piece of row) {
          if (piece) eval += piece.color === 'w' ? values[piece.type] : -values[piece.type];
        }
      }
      return eval;
    }
  </script>
</body>
</html>
